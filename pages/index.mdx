# La Wallet Documentation

## What is _La Wallet_ ?

An open source crypto wallet that provides ([BoltCard](https://www.boltcard.org)-compatible) [NTAG 424 DNA](https://www.nxp.com/products/rfid-nfc/nfc-hf/ntag-for-tags-and-labels/ntag-424-dna-424-dna-tagtamper-advanced-security-and-privacy-for-trusted-iot-applications:NTAG424DNA) card functionality.
This documentation will be centered around the constituent backend components:

- System Architecture
- Identity Provider
- Wallet Provider
  - Internal Modules

No specific prior knowledge is assumed, but an acquaintance with general software development and analysis practices is assumed.
Furthermore, programming knowledge should suffice to develop all of the La Wallet components from their descriptions herein.

## System Architecture

In a nutshell, the La Wallet System Architecture consists of two main components:

- the Identity Provider
- the Wallet Provider

The Identity provider is presented as a stand-alone component further down.
The Wallet provider is itself a [NOSTR](https://nostr.com)-connected set of inter-cooperating Internal Modules.

Graphically, the System Architecture looks like this:

![System Architecture](assets/system-architecture.png)

The internal components are:

- **API Gateway:** this is the main generic interface with the outside world.
    The API Gateway is in charge of basic authentication, rate limiting, pacing, etc., and it's also the one responsible for routing the given REST request to the module handling it (or to the Local NOSTR Relay, if applicable).
- **Local NOSTR Relay:** this is the backbone of the internal communication framework, **EVERY STATE-CHANGING MESSAGE SHOULD BE RUN THROUGH THE LOCAL NOSTR RELAY**, this is so that messages in the relay may be published to a _public_ relay for auditing.
- **Modules:** these are the interconnected pieces doing the actual work.
    Examples of actual internal modules are: Ledger Module, EVM-Gateway Module, NFC Card Module, etc.

The different arrows represent different _modes_ of interaction with the backend as a whole:

- **Generic REST Endpoints (A):** these constitute generic endpoints, realized as REST API requests.
    These are expected to conform to the established generic REST API guidelines imposed by the API Gateway (ie. authentication, rate-limiting, routing, etc.).
- **_Ad-Hoc_ REST Endpoints (B):** these constitute purpose-specific endpoints, that may or may not be realized as REST APIs (think `lnurl`-like endpoints that may expose a specification-defined behavior).
    These are _a-priori_ exempt from following the guidelines alluded to above, since the flows therein are not necessarily aligned with them; _however_, implementations are free to impose a separate, sensible, set of guidelines for these as well, so as to prevent deleterious behavior (eg. flooding, DoS, etc.).
- **Asynchronous NOSTR Messaging (C):** a generic endpoint exposed by the API Gateway simply serves as a way to publish a NOSTR event to the Local NOSTR Relay; this way, the external world is able to access the same _asynchronous_ interface the internal modules use themselves.
- **Synchronous NOSTR Messaging (D):** these are made available in order to expose a _synchronous_ NOSTR API to the outside works; the idea here is that certain user-flows require very low latency and are best served with dedicated endpoints, alas, we do not want to expose a potentially incompatible REST API in order to deal with these, thus, we expose an endpoint that will accept a NOSTR event and route it appropriately, with the understanding that said event will be eventually published to the Local NOSTR Relay (cf. dotted line in the diagram).
- **Internal NOSTR Messaging (E):** this is the main inter-module communication mechanism.
    Modules are expected to talk to other modules using NOSTR events.
    When doing so _asynchronously_, through the Local NOSTR Relay, modules are expected to establish a `REQ` subscription (cf. dashed lines in the diagram); when doing so _synchronously_, via Synchronous NOSTR Messaging, modules can expect the response (if any) to be delivered in the HTTP response body.
- **External NOSTR Subscription (F):** external clients are expected to establish a `REQ` subscription to the Local NOSTR Relay in order to update user status.

### Local NOSTR Relay Architecture

The Local NOSTR Relay serves a dual purpose:

1. on the one hand, it makes interacting between cooperating modules extremely simple and uniform,
2. on the other, it allows for all the messages posted therein to be later (or parallelly) published ot external NOSTR relays for auditing.

Internally, the Local NOSTR Relay is implemented thusly:

![Local NOSTR Relay Architecture](assets/nostr-architecture.png)

where:

- **Local NOSTR Relay:** is the local NOSTR relay where NOSTR events are published.
- **Read NOSTR Replica:** these are clusters of NOSTR relays that serve as read-only replicas.
- **C:** the externally-subscribed clients.

The interactions shown are:

- **NOSTR Event Publishing (A):** represents an event being published to the NOSTR subsystem.
- **Inter-relay Replication Stream (B):** represents the "relay-to-relay" high-speed replication stream.
- **Client Subscriptions (C):** represents the actual `REQ` subscriptions each external client established.
- **Internal Module Subscriptions (D):** represents the actual `REQ` subscriptions each Internal Module established.

Note how this keeps the load on the write-relay relatively low, requiring only as many `REQ` subscriptions as are established by the Internal Modules, and as many replication streams as there are read-only replicas.

The image above shows a simple, single-level replication structure, one could just as easily cascade read-only replicas in a tree structure so as to keep outgoing channels to a minimum in each specific relay; we judge that to only complicate exposition in this case, but large-scale implementations may very well require this.

### Internal Module (Generic) Architecture

An Internal Module's generic architecture looks like this:

![Internal Module Architecture](assets/module-architecture.png)

Its constituent parts are:

- **NOSTR _(optional)_ :** the main asynchronous NOSTR interface via which to publish and subscribe to the main NOSTR backbone.
- **Synchronous Nostr _(optional)_ :** a synchronous REST API that accepts a NOSTR event and asynchronously acts upon it.
- **Ad-Hoc REST API _(optional)_ :** a set of _ad-hoc_ REST API endpoints to support non-NOSTR-based flows.
- **Internal NOSTR Relay _(optional)_ :** an optional part of the Internal Module's architecture, its purpose is to act as a sort of "local read-only replica", so as to reduce the pressure on the main Local NOSTR Relay whilst at the same time providing all the required `REQ` subscriptions to the module's Business Logic.
- **Resources _(optional)_ :** an Internal Module is free to declare and use as many resources as it sees fit, they're their sole responsibility and the System Architecture at large knows not about them.
- **Business Logic:** the Internal Module's business logic component realizes the module's purpose (it may contain an internal router, expose different sets of ports for different APIs, whatever the Internal Module's writer desires, so long as the API Gateway knows how to interact with it).

### NOSTR Integration

> talk about NOSTR transparency integration

### NOSTR API

> talk about real-time NOSTR API for synchronous messaging

### REST API

> talk about ad-hoc REST APIs

---

## Components

### [Identity Provider](./identity-provider)

- Public Registry
- NIP-05
- LUD-16

### [Wallet Provider](./wallet-provider)

- Create Users
- Create Cards
- List Transactions
- Get balance
- Holds Wallet data
- Remove Card
- Make payments
- Generates LNURLp
- Emits transaction events on nostr on wallet transactions (send/receive)
